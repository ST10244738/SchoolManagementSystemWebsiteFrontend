import React, { useState, useEffect } from 'react';
import { tripAPI } from '../../services/api';

const TripManagement = () => {
    const [trips, setTrips] = useState([]);
    const [showAddForm, setShowAddForm] = useState(false);
    const [showEditForm, setShowEditForm] = useState(false);
    const [editingTrip, setEditingTrip] = useState(null);
    const [formData, setFormData] = useState({
        title: '',
        description: '',
        destination: '',
        imageUrl: '',
        price: '',
        tripDate: '',
        eligibleGrades: []
    });

    const grades = ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7'];

    useEffect(() => {
        loadTrips();
    }, []);

    const loadTrips = async () => {
        try {
            const response = await tripAPI.getAllTrips();
            if (response.data.success) {
                setTrips(response.data.data);
            }
        } catch (error) {
            console.error('Error loading trips:', error);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const tripData = {
                ...formData,
                price: parseFloat(formData.price)
            };

            const response = await tripAPI.createTrip(tripData);
            if (response.data.success) {
                setShowAddForm(false);
                setFormData({
                    title: '',
                    description: '',
                    destination: '',
                    imageUrl: '',
                    price: '',
                    tripDate: '',
                    eligibleGrades: []
                });
                loadTrips();
                alert('Trip created successfully!');
            }
        } catch (error) {
            alert('Failed to create trip');
        }
    };

    const handleGradeChange = (grade) => {
        const newGrades = formData.eligibleGrades.includes(grade)
            ? formData.eligibleGrades.filter(g => g !== grade)
            : [...formData.eligibleGrades, grade];

        setFormData({ ...formData, eligibleGrades: newGrades });
    };

    const handleEdit = (trip) => {
        setEditingTrip(trip);
        // Convert tripDate to YYYY-MM-DD format for date input
        let dateValue = trip.tripDate;
        if (dateValue && !dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // If date is in different format, try to convert it
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
                dateValue = date.toISOString().split('T')[0];
            }
        }

        setFormData({
            title: trip.title,
            description: trip.description,
            destination: trip.destination,
            imageUrl: trip.imageUrl || '',
            price: trip.price.toString(),
            tripDate: dateValue,
            eligibleGrades: trip.eligibleGrades
        });
        setShowEditForm(true);
    };

    const handleUpdate = async (e) => {
        e.preventDefault();
        try {
            const tripData = {
                ...formData,
                price: parseFloat(formData.price)
            };

            const response = await tripAPI.updateTrip(editingTrip.tripId, tripData);
            if (response.data.success) {
                setShowEditForm(false);
                setEditingTrip(null);
                setFormData({
                    title: '',
                    description: '',
                    destination: '',
                    imageUrl: '',
                    price: '',
                    tripDate: '',
                    eligibleGrades: []
                });
                loadTrips();
                alert('Trip updated successfully!');
            }
        } catch (error) {
            alert('Failed to update trip');
        }
    };

    const handleDelete = async (tripId) => {
        if (!window.confirm('Are you sure you want to delete this trip?')) return;

        try {
            const response = await tripAPI.deleteTrip(tripId);
            if (response.data.success) {
                loadTrips();
                alert('Trip deleted successfully!');
            }
        } catch (error) {
            alert('Failed to delete trip');
        }
    };

    return (
        <div className="trip-management">
            <div className="trip-header">
                <h2>Trip Management</h2>
                <button
                    onClick={() => setShowAddForm(true)}
                    className="btn-primary"
                >
                    Add New Trip
                </button>
            </div>

            {(showAddForm || showEditForm) && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3>{showEditForm ? 'Edit Trip' : 'Add New Trip'}</h3>
                        <form onSubmit={showEditForm ? handleUpdate : handleSubmit}>
                            <div className="form-group">
                                <label>Trip Title:</label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>Description:</label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    rows="3"
                                />
                            </div>

                            <div className="form-group">
                                <label>Destination:</label>
                                <input
                                    type="text"
                                    value={formData.destination}
                                    onChange={(e) => setFormData({...formData, destination: e.target.value})}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>Image URL:</label>
                                <input
                                    type="url"
                                    value={formData.imageUrl}
                                    onChange={(e) => setFormData({...formData, imageUrl: e.target.value})}
                                />
                            </div>

                            <div className="form-group">
                                <label>Price (R):</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.price}
                                    onChange={(e) => setFormData({...formData, price: e.target.value})}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>Trip Date:</label>
                                <input
                                    type="date"
                                    value={formData.tripDate}
                                    onChange={(e) => setFormData({...formData, tripDate: e.target.value})}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>Eligible Grades:</label>
                                <div className="checkbox-group">
                                    {grades.map(grade => (
                                        <label key={grade} className="checkbox-label">
                                            <input
                                                type="checkbox"
                                                checked={formData.eligibleGrades.includes(grade)}
                                                onChange={() => handleGradeChange(grade)}
                                            />
                                            {grade}
                                        </label>
                                    ))}
                                </div>
                            </div>

                            <div className="form-actions">
                                <button type="submit" className="btn-primary">
                                    {showEditForm ? 'Update Trip' : 'Create Trip'}
                                </button>
                                <button
                                    type="button"
                                    onClick={() => {
                                        setShowAddForm(false);
                                        setShowEditForm(false);
                                        setEditingTrip(null);
                                        setFormData({
                                            title: '',
                                            description: '',
                                            destination: '',
                                            imageUrl: '',
                                            price: '',
                                            tripDate: '',
                                            eligibleGrades: []
                                        });
                                    }}
                                    className="btn-secondary"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            <div className="trips-grid">
                {trips.map((trip) => (
                    <div key={trip.tripId} className="trip-card">
                        {trip.imageUrl && (
                            <img src={trip.imageUrl} alt={trip.title} className="trip-image" />
                        )}
                        <div className="trip-content">
                            <h3>{trip.title}</h3>
                            <p>{trip.description}</p>
                            <div className="trip-details">
                                <p><strong>Destination:</strong> {trip.destination}</p>
                                <p><strong>Date:</strong> {trip.tripDate}</p>
                                <p><strong>Price:</strong> R{trip.price}</p>
                                <p><strong>Eligible Grades:</strong> {trip.eligibleGrades.join(', ')}</p>
                                <p><strong>Registered:</strong> {trip.registeredStudents?.length || 0} students</p>
                            </div>
                            <div className="trip-actions" style={{
                                display: 'flex',
                                gap: '10px',
                                marginTop: '15px'
                            }}>
                                <button
                                    onClick={() => handleEdit(trip)}
                                    className="btn-primary"
                                    style={{ flex: 1 }}
                                >
                                    ‚úèÔ∏è Edit
                                </button>
                                <button
                                    onClick={() => handleDelete(trip.tripId)}
                                    className="btn-danger"
                                    style={{ flex: 1 }}
                                >
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

export default TripManagement;